<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ - ‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Prompt', sans-serif;
      background: #f1f5f9;
      padding: 0;
      margin: 0;
    }

    .container {
      max-width: 600px;
      margin: auto;
      padding: 2rem 1rem;
      text-align: center;
    }

    .logo {
      max-width: 220px;
      margin-bottom: 1rem;
    }

    h1 {
      font-size: 1.5rem;
      color: #2563eb;
    }

    #status {
      margin: 1rem 0;
      font-size: 1rem;
    }

    iframe {
      width: 100%;
      height: 800px;
      border: none;
      border-radius: 8px;
      display: none;
    }

    .loading {
      color: #888;
      font-style: italic;
    }
  </style>
  <script>
    const allowedLat = 17.203563793916324;
    const allowedLng = 102.43952852856776;
    const allowedRadius = 100; // ‡πÄ‡∏°‡∏ï‡∏£
    const webAppURL = "https://script.google.com/macros/s/AKfycbxh3jbfXaVvSvuyglXcNHVbYXGencUpn8AzZVZPccjMU_Odppgbs1gp2x30d8ycvDwlmQ/exec";

    function toRad(x) {
      return x * Math.PI / 180;
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    async function checkLastCheckIn(name) {
      const res = await fetch(`${webAppURL}?name=${encodeURIComponent(name)}`);
      const data = await res.json();
      return data;
    }

    function checkLocation() {
      const statusDiv = document.getElementById("status");
      const formFrame = document.getElementById("form-frame");

      if (navigator.geolocation) {
        statusDiv.innerHTML = "<span class='loading'>üìç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î...</span>";
        navigator.geolocation.getCurrentPosition(async function (position) {
          const userLat = position.coords.latitude;
          const userLng = position.coords.longitude;
          const distance = getDistance(userLat, userLng, allowedLat, allowedLng);

          if (distance <= allowedRadius) {
            const name = prompt("üìã ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:");

            if (!name) {
              statusDiv.innerHTML = "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠";
              return;
            }

            const result = await checkLastCheckIn(name);
            if (result.status === "blocked") {
              alert(`‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ${result.diff} ‡∏ô‡∏≤‡∏ó‡∏µ\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 60 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`);
              statusDiv.innerHTML = "‚õî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ";
            } else {
              statusDiv.innerHTML = `‚úÖ ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï`;
              formFrame.style.display = "block";
            }
          } else {
            statusDiv.innerHTML = `‚ùå ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏´‡πà‡∏≤‡∏á ${distance.toFixed(1)} ‡πÄ‡∏°‡∏ï‡∏£)`;
          }
        }, function (error) {
          statusDiv.innerHTML = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ: " + error.message;
        });
      } else {
        statusDiv.innerHTML = "‚ùå ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS";
      }
    }

    window.onload = checkLocation;
  </script>
</head>
<body>
  <div class="container">
    <img src="https://raw.githubusercontent.com/veerapolkanpat/checkin/main/logo.png" class="logo" alt="Logo" />
    <h1>üìå ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ - ‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</h1>
    <div id="status">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    <iframe id="form-frame" src="https://docs.google.com/forms/d/e/1FAIpQLSdcG0HOPDYiY-3gvRpb2lJ7utYWHw6i7rHXSJ1ly3mWH9Fp-w/viewform?embedded=true"></iframe>
  </div>
</body>
</html>
